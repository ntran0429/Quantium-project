"0","#### Calculate the metrics below as we did for the first trial store."
"0","measureOverTime <- data[, .(totSales = sum(TOT_SALES),"
"0","                            nCustomers = uniqueN(LYLTY_CARD_NBR),"
"0","                            nTxnPerCust = uniqueN(TXN_ID)/uniqueN(LYLTY_CARD_NBR), "
"0","                            nChipsPerCust = sum(PROD_QTY)/uniqueN(LYLTY_CARD_NBR),"
"0","                            avgPricePerUnit = sum(TOT_SALES)/sum(PROD_QTY)), "
"0","                        by = .(STORE_NBR,YEARMONTH)][order(STORE_NBR,YEARMONTH)]"
"0",""
"0",""
"0","#### Use the functions we created earlier to calculate correlations"
"0","#### and magnitude for each potential control store"
"0","trial_store <- 86"
"0",""
"0","corr_nSales <- calculateCorrelation(preTrialMeasures, quote(totSales),trial_store)"
"0","corr_nCustomers <- calculateCorrelation(preTrialMeasures, quote(nCustomers),trial_store)"
"0",""
"0","magnitude_nSales <- calculateMagnitudeDistance(preTrialMeasures,quote(totSales),trial_store)"
"0","magnitude_nCustomers <- calculateMagnitudeDistance(preTrialMeasures,quote(nCustomers), trial_store)"
"0",""
"0","#### Now, create a combined score column composed of correlation and magnitude"
"0","corr_weight <- 0.5"
"0",""
"0","score_nSales <- merge(corr_nSales, magnitude_nSales, by = c(""Store1"",""Store2""))[, scoreNSales := corr_measure * corr_weight + mag_measure * (1-corr_weight)]"
"0",""
"0","score_nCustomers <- merge(corr_nCustomers, magnitude_nCustomers, by = c(""Store1"", ""Store2""))[, scoreNCust := corr_measure * corr_weight + mag_measure * (1-corr_weight)]"
"0",""
"0","#### Finally, combine scores across the drivers using a simple average."
"0","score_Control <- merge(score_nSales,score_nCustomers, by = c(""Store1"",""Store2""))"
"0","score_Control[, finalControlScore := scoreNSales * 0.5 + scoreNCust * 0.5]"
"0",""
"0","#### Select control stores based on the highest matching store"
"0","#### (closest to 1 but not the store itself, i.e. the second ranked highest store)"
"0","#### Select control store for trial store 86"
"0","control_store <- score_Control[Store1 == trial_store,][order(-finalControlScore)][2, Store2]"
"0","control_store"
"1","[1]"
"1"," 155"
"1","
"
