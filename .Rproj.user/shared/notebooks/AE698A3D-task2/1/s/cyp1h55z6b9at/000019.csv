"0","#### This would be a repeat of the steps before for total sales"
"0","#### Scale pre-trial control store customers to match pre-trial trial store customers"
"0","scalingFactorForControlCust <- preTrialMeasures[STORE_NBR == trial_store & YEARMONTH < 201902, sum(nCustomers)] / preTrialMeasures[STORE_NBR == control_store & YEARMONTH < 201902, sum(nCustomers)]"
"0",""
"0","#### Apply the scaling factor"
"0","measureOverTimeCusts <- measureOverTime"
"0","scaledControlCustomers <- measureOverTimeCusts[STORE_NBR == control_store,"
"0","                                               ][ , controlCustomers := nCustomers * scalingFactorForControlCust"
"0","                                                  ][, Store_type := ifelse(STORE_NBR == trial_store, ""Trial"","
"0","                                                                           ifelse(STORE_NBR == control_store,""Control"","
"0","                                                                                  ""Other stores""))]"
"0",""
"0","#### Calculate the absolute percentage difference between scaled control sales and trial sales"
"0","percentageDiff <- merge(scaledControlCustomers[, c(""YEARMONTH"",""controlCustomers"")],measureOverTime[STORE_NBR == trial_store,c(""nCustomers"", ""YEARMONTH"")],by = ""YEARMONTH"")[, percentDiff := abs(controlCustomers-nCustomers)/controlCustomers]"
"0",""
"0",""
"0","#### As our null hypothesis is that the trial period is the same as the pre-trial"
"0","# period, let's take the standard deviation based on the scaled percentage difference"
"0","# in the pre-trial period"
"0",""
"0","stdDev <- sd(percentageDiff[YEARMONTH < 201902 , percentDiff])"
"0",""
"0","degreesOfFreedom <- 7 # note that there are 8 months in the pre-trial period hence 8 - 1 = 7 degrees of freedom"
"0",""
"0","#### Trial and control store number of customers"
"0","measureOverTimeCusts <- measureOverTime"
"0","pastCustomers <- measureOverTimeCusts[ , Store_type := ifelse(STORE_NBR == trial_store, ""Trial"","
"0","                                                   ifelse(STORE_NBR == control_store, ""Control"", ""Other stores""))][, nCusts := mean(nCustomers), by = c(""YEARMONTH"", ""Store_type"")][, TransactionMonth := as.Date(paste(as.numeric(YEARMONTH) %/% 100, as.numeric(YEARMONTH) %% 100, 1, sep = ""-""), ""%Y-%m-%d"")][Store_type %in% c(""Trial"", ""Control""),]"
"0",""
"0","#### Control store 95th percentile"
"0","pastCustomers_Controls95 <- pastCustomers[Store_type == ""Control"",] [, nCusts := nCusts * (1 + stdDev * 2)][, Store_type := ""Control 95th % confidence""]"
"0",""
"0","#### Control store 5th percentile"
"0","pastCustomers_Controls5 <- pastCustomers[Store_type == ""Control"",][,nCusts := nCusts * (1 - stdDev * 2)][, Store_type := ""Control 5th % confidence""]"
"0",""
"0","#### Combine the tables pastSales, pastSales_Controls95, pastSales_Controls5"
"0","trialAssessment <- rbind(pastCustomers, pastCustomers_Controls95, pastCustomers_Controls5)"
"0",""
"0","#### Plotting these in one nice graph"
"0","ggplot(trialAssessment, aes(TransactionMonth, nCusts, color = Store_type)) +"
"0","  geom_rect(data = trialAssessment[YEARMONTH > 201901 & YEARMONTH < 201905, ],"
"0","            aes(xmin = min(TransactionMonth), xmax = max(TransactionMonth), "
"0","                ymin = 0 , ymax = Inf, color = NULL), show.legend = FALSE) +"
"0","  geom_line() +"
"0","  geom_point() +"
"0","  labs(x = ""Month of operation"", y = ""Total customers"", title = ""Total customers by month"")"
"0",""
